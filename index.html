<!DOCTYPE HTML>
<html>
    <head>
		<meta charset="UTF-8">
		<style>
            body {
                margin: 10px;
                padding: 10px;
                font-family : sans-serif;
                font-size : 11pt;
            }

			.results {
				vertical-align: top;
			}
			
			#target {
				display : inline-block;
				vertical-align: middle;
			}
			.stats-table {
				display : inline-block;
				border-collapse: collapse;
				vertical-align: middle;
			}
			.stats-table th, .stats-table td {
				border-bottom : 1px solid rgba(0,0,0,0.1);
				padding : 4px 10px;
			}
			.stats-table .value {
				min-width : 4em;
				text-align : right;
			}
        </style>
        <script src="target-graphic.js"></script>
          
    </head>
  
    <body>
        <h1>The Perfect Shot</h2>
        <p>We have perfect powder, no wind and no human error. This represents just the inherent imprecision of a firearm with a bias of (0,0) and a normally distributed spread with the given sigma.</p>
		<p>Small groups have an apparent bias while the distribution being drawn from has none.</p>
		<p>Below is my standard 200m target. The grid size is 14 mm. One square MOA is a four by four divisions.</p>
        <p class="results">
			<table class="stats-table">
				<tr><td>Max:</td>   <td class="value" id="max"></td></tr>
				<tr><td>ATC:</td>   <td class="value" id="atc"></td></tr>
				<tr><td>Width:</td> <td class="value" id="width"></td></tr>
				<tr><td>Height:</td><td class="value" id="height"></td></tr>
				<tr><td>Vertical bias:</td>  <td class="value" id="vert"></td></tr>
				<tr><td>Horizontal bias:</td> <td class="value" id="horiz"></td></tr>
				<tr><td>Estimated &sigma;:</td> <td class="value" id="estimated_sigma"></td></tr>
				
			</table>
			<canvas width="600" height="600"  id="target"></canvas>
		</p>
		<p class="inputs">
        <input type="checkbox" id="show_atc"   onclick="refresh()" /> Show what ATC is for the whole distribution for the given &sigma;</br>
        <input type="checkbox" id="show_probs" onclick="refresh()" /> Show radius for <select id="prob_select" onchange="refresh()">
            <option value="0.5">CEP (50%)</option>
            <option value="0.95">R95</option>
            <option value="0.99">99%</option>
            <option value="0.999" selected>99.9%</option>
            <option value="0.9999">99.99%</option>
            <option value="0.99999">99.999%</option>
            <option value="0.999999">99.9999%</option>
        </select> probability of any given shot hit. <br/>
        <input type="checkbox" id="show_stats" checked onclick="refresh()"/> Show group statistics<br />
        Shots: <input type="text" id="group" value="5" size="4" style="text-align:right;" />
        &sigma;: <input type="text" id="sigma" value="18" size="4" style="text-align:right;" onchange="refresh()"/>mm<br />
        Average to center is about 25% more than the sigma.<br/>
        <button onClick="DoGroup(
              parseInt(document.getElementById('group').value),
			  parseFloat(document.getElementById('sigma').value))">Draw a random group</button>
		</p>    
	
	</body>
	  
	<script>
    // Normal distribution generator.
    function Normal(mean, stdev) {
        var y2;
        var use_last = false;

        return function() {
            var y1;
            if(use_last) {
                y1 = y2;
                use_last = false;
            } 
            else {
                var x1;
                var x2;
                var w;
                do {
                    x1 = 2.0 * Math.random() - 1.0;
                    x2 = 2.0 * Math.random() - 1.0;
                    w = x1 * x1 + x2 * x2;
                } while(w >= 1.0);

                w = Math.sqrt( (-2.0 * Math.log(w) ) / w );
                y1 = x1 * w;
                y2 = x2 * w;
                use_last = true;
            }
            return mean + stdev * y1;
        }
    }

    let tgt = new TargetGraphic('target');

    // calculate the statistics for the group
    function calculateStats(shots) {
        var avg = new shot(0,0);
        var min = new shot(0,0);
        var max = new shot(0,0);
        var M = new shot(shots[0].x, shots[0].y);
        var Q = new shot(0,0);
		for(var i=0; i<shots.length; i++) {
            var s = shots[i];
            avg.x += s.x / shots.length;
            avg.y += s.y / shots.length;
            Q.x = Q.x + (i * (s.x - M.x)*(s.x - M.x))/(i+1);
            Q.y = Q.y + (i * (s.y - M.y)*(s.y - M.y))/(i+1);
            M.x = M.x + (s.x - M.x)/(i+1)
            M.y = M.y + (s.y - M.y)/(i+1)

            if(s.x < min.x) min.x = s.x;
            if(s.x > max.x) max.x = s.x;
            if(s.y < min.y) min.y = s.y;
            if(s.y > max.y) max.y = s.y;
        }
		
        if(shots.length > 1) {
            Q.x = Math.sqrt(Q.x/(shots.length-1));
			Q.y = Math.sqrt(Q.y/(shots.length-1));
		}
        else {
            Q.x = 0;
            Q.y = 0;
        }

        let from = 0;
        let to = 0;
        let maxdist = 0;
        for(let i=0; i<(shots.length-1); i++) {
            for(let j=i+1; j<shots.length; j++) {
                let d = shots[i].distance(shots[j]);
                if(d > maxdist) {
                    maxdist = d;
                    from = i;
                    to   = j;
                }
            }
		}

		let atc = shots.reduce((total, shot) => { return total + shot.distance(avg)}, 0) / shots.length;
		return {
            average         : avg,
            maxfrom         : shots[from],
            maxto           : shots[to],
            averageToCenter : atc,
            min             : min,
            max             : max, 
            stdev           : Q,
			sizex           : max.x - min.x,
			sizey           : max.y - min.y
		}
    }

    var shots = [];

    function refresh() {
        if(tgt == null) tgt = new TargetGraphic('target');
        tgt.setGridSize(14);
        tgt.setScale(4);
        tgt.setCenter(300.5, 300.5);
        tgt.makeTarget();
        let prob  = parseFloat(document.getElementById('prob_select').value);
        let sigma = parseFloat(document.getElementById('sigma').value);
        tgt.showOverlay = document.getElementById('show_stats').checked;

        if(document.getElementById('show_atc').checked)  tgt.drawATC(sigma);
        if(document.getElementById('show_probs').checked) tgt.drawProbabilities(sigma, prob)

        for(var i=0; i<shots.length; i++) tgt.drawBulletHole(shots[i].x, shots[i].y);
		let stats = calculateStats(shots);
		document.getElementById("max").innerText = `${stats.maxfrom.distance(stats.maxto).toFixed(0)} mm`;
		document.getElementById("atc").innerText = `${stats.averageToCenter.toFixed(1)} mm`;
		document.getElementById("width").innerText = `${stats.sizex.toFixed(0)} mm`;
		document.getElementById("height").innerText = `${stats.sizey.toFixed(0)} mm`;
		document.getElementById("vert").innerText = `${(stats.average.y).toFixed(0)} mm`;
		document.getElementById("horiz").innerText = `${stats.average.x.toFixed(0)} mm`;
		document.getElementById("estimated_sigma").innerText = `${(0.5*(stats.stdev.x + stats.stdev.y)).toFixed(0)} mm`;        
		
		tgt.drawStats(stats); 
	}

        // Generate a group
    function DoGroup(count, sigma) {
        var group = count;
        // var wind = Normal(-28, 12);
        var xvar = Normal(0, sigma);
        var yvar = Normal(0, sigma);
        shots = [];
        for(var i=0; i<group; i++) shots[i] = new shot(xvar(), yvar());
        
        refresh();
    }


    DoGroup(parseInt(document.getElementById('group').value), parseFloat(document.getElementById('sigma').value));
  	</script>
</html>
